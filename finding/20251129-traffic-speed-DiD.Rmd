---
title: "20251129-traffic-speed-DiD"
author: "Cheng-Heng, Yuan"
output: html_document
date: "`r format(Sys.time(), '%Y-%m-%d')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Background

- **Author**: `<Cheng-Heng, Yuan>`
- **Created At**: `<2025-11-29>`
- **Research Motivation and Context (why are we interested in the findings?)：** We want to see the average speed change after the implementation of congestion fee policy.
- **Main Findings and Takeaways：** Using a difference-in-differences approach, congestion pricing is found to significantly increase traffic speeds in the CBD. Average speeds rise by about 3.8 mph relative to non-CBD routes overall, with a larger increase of roughly 6.5 mph in the first six months after implementation. These results indicate that congestion pricing was effective, especially in the early phase of the policy.

```{r}
# Load packages here
library(dplyr)
library(fixest)
library(tidyverse)
library(forcats)
library(lubridate)
library(tidyr)
library(purrr)
library(ggplot2)
library(slider)
```

```{r}
# Load input data here and please finish all the data manipulation here.
processed_speeds <- read.csv("speed-mht.csv")
speeds <- processed_speeds %>%
  filter(SPEED > 0, TRAVEL_TIME > 0) %>%
  mutate(
    date = as.Date(DATA_AS_OF), month = month(DATA_AS_OF), wday = wday(DATA_AS_OF),
    post  = as.integer(year(DATA_AS_OF) == 2025),
    CBD   = case_when(
      is_in_CBD == "not in CBD" ~ 0L,
      is_in_CBD == "partially or all in CBD" ~ 1L,
      TRUE ~ NA_integer_
    )
  ) %>%
  filter(month <= 10) %>%
  group_by(CBD, date, month, wday, post) %>%
  summarise(wt_speed = weighted.mean(SPEED, TRAVEL_TIME, na.rm = TRUE),.groups  = "drop")

head(speeds, 10)

speeds_6 <- speeds %>%
  filter(month <= 6)

head(speeds_6, 10)
# Finish this block by printing the first ten observations of the data.
# Note:
# - You may only read data from /data/processed.
# - Files in /data/processed should already be cleaned and prepared for analysis.
# - Beyond simple filtering of observations or generating a small number of variables,
#   further data manipulation is not allowed. If more extensive changes are needed,
#   update the source data instead.
```

```{r}
# Before conducting the analysis, report summary statistics for all variables 
# that will be used in this notebook:
#   - For numeric variables: mean, min, 25th percentile, median, 75th percentile, 
#     max, standard deviation, and number of observations.
#   - For categorical variables: number of observations and the counts/percentages 
#     of the ten most frequent categories.
# Conclude this block with the complete summary statistics.

# number of observations
nrow(speeds)

summary_stats <- function(var) {
  s <- summary(speeds[[var]])
  sd_val <- sd(speeds[[var]], na.rm = TRUE)

  tibble(
    variable = var,
    stat = c(names(s), "sd"),
    value = c(as.character(s), sprintf("%.4f", sd_val))
  )
}

combined_summary <- map_dfr(c("wt_speed", "date"), summary_stats) %>%
  pivot_wider(names_from = stat, values_from = value)

combined_summary

#categorical variables
summary_category <- speeds %>%
  select(CBD, post, month, wday) %>%
  pivot_longer(
    cols = everything(),
    names_to = "variable",
    values_to = "category"
  ) %>%
  group_by(variable, category) %>%
  summarise(
    n = n(),
    .groups = "drop_last"
  ) %>%
  mutate(ratio = n / sum(n)) %>%
  ungroup()

summary_category
```

### The actual analysis starts below
```{r}
did_fe_1 <- feols(
  wt_speed ~ CBD:post + CBD + post + factor(wday) + factor(month),
  data    = speeds
) 
summary(did_fe_1)
```

Controlling for day-of-week and month effects, the difference-in-differences estimate indicates that congestion pricing increased average traffic speeds in the CBD by approximately 3.7 miles per hour (mph) relative to non-CBD routes. The effect is precisely estimated (t = 10.27, p < 0.001), making it highly unlikely that the result is driven by random variation. This finding suggests that the policy substantially improved traffic flow within the treated area compared with the rest of the city.

```{r}
did_fe_2 <- feols(
  wt_speed ~ CBD:post + CBD + post + factor(wday) + factor(month),
  data    = speeds_6
) 
summary(did_fe_2)
```

Restricting the sample to the first six months after implementation, the difference-in-differences estimate shows a substantially larger treatment effect. Controlling for day-of-week and month fixed effects, congestion pricing increased average CBD traffic speeds by approximately 6.5 mph relative to non-CBD routes. The effect is precisely estimated (t = 13.39, p < 0.001), indicating strong statistical significance. While overall speeds declined in the post period, the positive interaction term implies that the policy more than offset this decline within the CBD. This result suggests that the congestion pricing impact was strongest during the initial phase of treatment.

