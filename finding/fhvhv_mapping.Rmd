---
title: "NYC Mapping"
author: "Yao, Ju-Chien b12303125"
date: "`r Sys.Date()`"
output: 
  html_notebook:
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: true
---

## Setting up

```{r Importing data, include = FALSE} 
remove(list = ls())
library(sf)
library(tmap)
library(dplyr)
library(tidyr)
library(arrow)

# Reading Data
nyc_shp = st_read("C:/114-1_Autumn/Data_science_and_social_inquiry/data/nyc_map/taxi_zones.shp")

# Selecting Manhattan
mht_shp = nyc_shp %>%
  filter(borough == "Manhattan")

# Selecting data in Manhattan
mht_index = mht_shp$LocationID
mht_centroids = st_centroid(mht_shp)

pre_fhvhv = read_parquet("C:/114-1_Autumn/Data_science_and_social_inquiry/data/nyc_july2024/fhvhv_tripdata_2024-07.parquet") %>% 
  filter(PULocationID %in% mht_index & DOLocationID %in% mht_index) %>%
  select(PULocationID, DOLocationID)

post_fhvhv = read_parquet("C:/114-1_Autumn/Data_science_and_social_inquiry/data/nyc_july2025/fhvhv_tripdata_2025-07.parquet") %>%
  filter(PULocationID %in% mht_index & DOLocationID %in% mht_index) %>%
  select(PULocationID, DOLocationID)
```

```{r}
tm_shape(mht_shp) +
  tm_polygons()
```

## Combining the data with cars flow

### setting the slice
```{r}
slice_n = 50
```



```{r}
# 自訂一個函數處理 FHV/FHVHV dataset
plot_top50_flows <- function(data, pu_col = "PULocationID", do_col = "DOLocationID",
                             map_title = "OD Flow Map", slice_n = 100,
                             save_path = NULL) {
  
  # 1️⃣ 聚合成 OD matrix
  od_matrix <- data %>%
    group_by(across(all_of(c(pu_col, do_col)))) %>%
    summarise(trips = n(), .groups = "drop")
  
  # 2️⃣ 選出流量前 slice_n 條
  top50 <- od_matrix %>%
    arrange(desc(trips)) %>%
    slice_head(n = slice_n)
  
  # 3️⃣ 取得起終點中心點
  top50 <- top50 %>%
    left_join(mht_centroids %>% select(!!pu_col := LocationID, start_geom = geometry),
              by = pu_col) %>%
    left_join(mht_centroids %>% select(!!do_col := LocationID, end_geom = geometry),
              by = do_col)
  
  # 4️⃣ 建立 LINESTRING
  lines_list <- lapply(1:nrow(top50), function(i) {
    st_linestring(rbind(st_coordinates(top50$start_geom[i]),
                        st_coordinates(top50$end_geom[i])))
  })
  
  flows_sf <- st_sf(
    PULocationID = top50[[pu_col]],
    DOLocationID = top50[[do_col]],
    trips = top50$trips,
    geometry = st_sfc(lines_list, crs = st_crs(mht_shp))
  )
  
  # 5️⃣ 畫 tmap
  map_plot <- tm_shape(mht_shp) +
    tm_borders(col = "grey70") +
    tm_shape(flows_sf) +
      tm_lines(lwd = "trips", scale = 6, col = "blue", alpha = 0.4) +
    tm_shape(mht_centroids) +
      tm_dots(size = 0.05, col = "red") +
    tm_legend(
      orientation = "portrait",
      position = c("right", "bottom"),
      text.size = 1.5,
      title.size = 2
    ) + 
  tm_compass(type = "4star", size = 0.8, position = c(0.05, 0.85)) + 
  tm_title(text = map_title,
           position = c(0.05, 0.95)) + 
  tm_scalebar(position = c(0.5, 0.15), size = 0.8)
  
  # 6️⃣ 如果指定存檔路徑就存檔
  if (!is.null(save_path)) {
    tmap_save(map_plot, filename = save_path, width = 2000, height = 2000, dpi = 300)
  }
  
  return(map_plot)
}

# --------------------------------------------------
# 使用這個函數處理兩個 dataset

# 1️⃣ pre_fhvhv
post_map_fhv <- plot_top50_flows(pre_fhvhv,
                                 pu_col = "PULocationID",
                                 do_col = "DOLocationID",
                                 map_title = "FHVHV flow on July 2024",
                                 save_path = "C:/114-1_Autumn/Data_science_and_social_inquiry/nyc_mapping/pre_map_fhvhv.png")

# 2️⃣ post_fhvhv
post_map_fhvhv <- plot_top50_flows(post_fhvhv,
                                   pu_col = "PULocationID",
                                   do_col = "DOLocationID",
                                   map_title = "FHVHV flow on July 2025",
                                   save_path = "C:/114-1_Autumn/Data_science_and_social_inquiry/nyc_mapping/post_map_fhvhv.png")

```