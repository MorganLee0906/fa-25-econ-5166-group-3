---
title: "NYC Mapping"
author: "Yao, Ju-Chien b12303125"
date: "`r Sys.Date()`"
output: 
  html_notebook:
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: true
---

## Setting up

```{r Importing data, include = FALSE} 
remove(list = ls())
library(sf)
library(tmap)
library(dplyr)
library(tidyr)
library(arrow)

# Reading Data
nyc_shp = st_read("C:/114-1_Autumn/Data_science_and_social_inquiry/data/nyc_map/taxi_zones.shp")

# Selecting Manhattan
mht_shp = nyc_shp %>%
  filter(borough == "Manhattan")

# Selecting data in Manhattan
mht_index = mht_shp$LocationID

pre_fhv = read_parquet("C:/114-1_Autumn/Data_science_and_social_inquiry/data/nyc_july2024/fhv_tripdata_2024-07.parquet") %>% 
  filter(PUlocationID %in% mht_index & DOlocationID %in% mht_index) %>%
  select(PUlocationID, DOlocationID)

#pre_green = read_parquet("C:/114-1_Autumn/Data_science_and_social_inquiry/data/nyc_july2024/green_tripdata_2024-07.parquet") %>% 
  #filter(PULocationID %in% mht_index & DOLocationID %in% mht_index) %>%
  #select(PULocationID, DOLocationID)

#pre_yellow = read_parquet("C:/114-1_Autumn/Data_science_and_social_inquiry/data/nyc_july2024/yellow_tripdata_2024-07.parquet") %>% 
  #filter(PULocationID %in% mht_index & DOLocationID %in% mht_index) %>%
  #select(PULocationID, DOLocationID)

pre_fhvhv = read_parquet("C:/114-1_Autumn/Data_science_and_social_inquiry/data/nyc_july2024/fhvhv_tripdata_2024-07.parquet") %>% 
  filter(PULocationID %in% mht_index & DOLocationID %in% mht_index) %>%
  select(PULocationID, DOLocationID)

post_fhv = read_parquet("C:/114-1_Autumn/Data_science_and_social_inquiry/data/nyc_july2025/fhv_tripdata_2025-07.parquet") %>%
  filter(PUlocationID %in% mht_index & DOlocationID %in% mht_index) %>%
  select(PUlocationID, DOlocationID)

#post_yellow = read_parquet("C:/114-1_Autumn/Data_science_and_social_inquiry/data/nyc_july2025/yellow_tripdata_2025-07.parquet")

#post_green = read_parquet("C:/114-1_Autumn/Data_science_and_social_inquiry/data/nyc_july2025/green_tripdata_2025-07.parquet")

post_fhvhv = read_parquet("C:/114-1_Autumn/Data_science_and_social_inquiry/data/nyc_july2025/fhvhv_tripdata_2025-07.parquet") %>%
  filter(PULocationID %in% mht_index & DOLocationID %in% mht_index) %>%
  select(PULocationID, DOLocationID)
```

```{r}
tm_shape(mht_shp) +
  tm_polygons()
```

## Combining the data with cars flow

### setting the slice
```{r}
slice_n = 75
```

```{r}
# 1️⃣ 聚合成 OD matrix
fhv_od = pre_fhv %>%
  group_by(PUlocationID, DOlocationID) %>%
  summarise(trips = n(), .groups = "drop")

# 2️⃣ 選出流量前 50 條
fhv_top50 = fhv_od %>%
  arrange(desc(trips)) %>%
  slice_head(n = slice_n)

# 3️⃣ 取得起終點中心點
mht_centroids = st_centroid(mht_shp)

fhv_top50 = fhv_top50 %>%
  left_join(mht_centroids %>% select(PUlocationID = LocationID, start_geom = geometry),
            by = "PUlocationID") %>%
  left_join(mht_centroids %>% select(DOlocationID = LocationID, end_geom = geometry),
            by = "DOlocationID")

# 4️⃣ 建立 LINESTRING
lines_list <- lapply(1:nrow(fhv_top50), function(i) {
  st_linestring(rbind(st_coordinates(fhv_top50$start_geom[i]),
                      st_coordinates(fhv_top50$end_geom[i])))
})

fhv_flows <- st_sf(
  PUlocationID = fhv_top50$PUlocationID,
  DOlocationID = fhv_top50$DOlocationID,
  trips = fhv_top50$trips,
  geometry = st_sfc(lines_list, crs = st_crs(mht_shp))
)

# 5️⃣ 畫 tmap
#library(scales)

# 假設 fhv_flows 有一個 trips 欄位
#fhv_flows <- fhv_flows %>%
  #mutate(lwd = rescale(trips, to = c(1, 100)))   # 把線寬縮放到 [0.5, 8]

pre_map_fhv <- 
  tm_shape(mht_shp) +
    tm_borders(col = "grey70") +
  tm_shape(fhv_flows) +
    tm_lines(lwd = "trips", scale = 6, col = "blue", alpha = 0.4) +   # 用預算好的 lwd
    tm_legend(
    orientation = "portrait",
    position = c("right", "bottom"),
    text.size = 1.5,
    title.size = 2
  ) + 
  tm_shape(mht_centroids) +
    tm_dots(size = 0.05, col = "red") +
    tm_compass(type = "4star", size = 0.8, position = c(0.05, 0.85)) + 
    tm_title(text = "FHV flow on July 2024",
           position = c(0.05, 0.95)) + 
    tm_scalebar(position = c(0.5, 0.15), size = 0.8)


tmap_save(pre_map_fhv, filename = "C:/114-1_Autumn/Data_science_and_social_inquiry/nyc_mapping/pre_map_fhv.png",
          width = 2000, height = 2000, dpi = 300)
```



```{r}
# 1️⃣ 聚合成 OD matrix
fhv_od_post = post_fhv %>%
  group_by(PUlocationID, DOlocationID) %>%
  summarise(trips = n(), .groups = "drop")

# 2️⃣ 選出流量前 50 條
fhv_top50_post = fhv_od_post %>%
  arrange(desc(trips)) %>%
  slice_head(n = slice_n)

# 3️⃣ 取得起終點中心點
# 使用之前的 mht_centroids
fhv_top50_post = fhv_top50_post %>%
  left_join(mht_centroids %>% select(PUlocationID = LocationID, start_geom = geometry),
            by = "PUlocationID") %>%
  left_join(mht_centroids %>% select(DOlocationID = LocationID, end_geom = geometry),
            by = "DOlocationID")

# 4️⃣ 建立 LINESTRING
lines_list_post <- lapply(1:nrow(fhv_top50_post), function(i) {
  st_linestring(rbind(st_coordinates(fhv_top50_post$start_geom[i]),
                      st_coordinates(fhv_top50_post$end_geom[i])))
})

fhv_flows_post <- st_sf(
  PUlocationID = fhv_top50_post$PUlocationID,
  DOlocationID = fhv_top50_post$DOlocationID,
  trips = fhv_top50_post$trips,
  geometry = st_sfc(lines_list_post, crs = st_crs(mht_shp))
)

# 5️⃣ 畫 tmap
post_map_fhv <- 
  tm_shape(mht_shp) +
    tm_borders(col = "grey70") +
  tm_shape(fhv_flows_post) +
    tm_lines(lwd = "trips", scale = 6, col = "blue", alpha = 0.4) +
  tm_shape(mht_centroids) +
    tm_dots(size = 0.05, col = "red") +
    tm_legend(
      orientation = "portrait",
      position = c("right", "bottom"),
      text.size = 1.5,
      title.size = 2
    ) + 
  tm_compass(type = "4star", size = 0.8, position = c(0.05, 0.85)) + 
  tm_title(text = "FHV flow on July 2025",
           position = c(0.05, 0.95)) + 
  tm_scalebar(position = c(0.5, 0.15), size = 0.8)

# 存檔
tmap_save(post_map_fhv, 
          filename = "C:/114-1_Autumn/Data_science_and_social_inquiry/nyc_mapping/post_map_fhv.png",
          width = 2000, height = 2000, dpi = 300)
```

```{r}
# 自訂一個函數處理 FHV/FHVHV dataset
plot_top50_flows <- function(data, pu_col = "PUlocationID", do_col = "DOlocationID",
                             map_title = "OD Flow Map", slice_n = 50,
                             save_path = NULL) {
  
  # 1️⃣ 聚合成 OD matrix
  od_matrix <- data %>%
    group_by(across(all_of(c(pu_col, do_col)))) %>%
    summarise(trips = n(), .groups = "drop")
  
  # 2️⃣ 選出流量前 slice_n 條
  top50 <- od_matrix %>%
    arrange(desc(trips)) %>%
    slice_head(n = slice_n)
  
  # 3️⃣ 取得起終點中心點
  top50 <- top50 %>%
    left_join(mht_centroids %>% select(!!pu_col := LocationID, start_geom = geometry),
              by = pu_col) %>%
    left_join(mht_centroids %>% select(!!do_col := LocationID, end_geom = geometry),
              by = do_col)
  
  # 4️⃣ 建立 LINESTRING
  lines_list <- lapply(1:nrow(top50), function(i) {
    st_linestring(rbind(st_coordinates(top50$start_geom[i]),
                        st_coordinates(top50$end_geom[i])))
  })
  
  flows_sf <- st_sf(
    PUlocationID = top50[[pu_col]],
    DOlocationID = top50[[do_col]],
    trips = top50$trips,
    geometry = st_sfc(lines_list, crs = st_crs(mht_shp))
  )
  
  # 5️⃣ 畫 tmap
  map_plot <- tm_shape(mht_shp) +
    tm_borders(col = "grey70") +
    tm_shape(flows_sf) +
      tm_lines(lwd = "trips", scale = 6, col = "blue", alpha = 0.4) +
    tm_shape(mht_centroids) +
      tm_dots(size = 0.05, col = "red") +
    tm_layout(
      title = map_title,
      title.position = c("center", "top"),
      legend.outside = TRUE,
      legend.outside.position = "right",
      legend.stack = "vertical",
      frame = FALSE,
      bg.color = "white"
    ) +
    tm_compass(type = "4star", size = 0.8, position = c(0.05, 0.85)) +
    tm_scale_bar(position = c(0.5, 0.15), size = 0.8)
  
  # 6️⃣ 如果指定存檔路徑就存檔
  if (!is.null(save_path)) {
    tmap_save(map_plot, filename = save_path, width = 2000, height = 2000, dpi = 300)
  }
  
  return(map_plot)
}

# --------------------------------------------------
# 使用這個函數處理兩個 dataset

# 1️⃣ post_fhv
post_map_fhv <- plot_top50_flows(post_fhv,
                                 pu_col = "PUlocationID",
                                 do_col = "DOlocationID",
                                 map_title = "FHV flow on July 2025",
                                 save_path = "C:/114-1_Autumn/Data_science_and_social_inquiry/nyc_mapping/post_map_fhv.png")

# 2️⃣ post_fhvhv
post_map_fhvhv <- plot_top50_flows(post_fhvhv,
                                   pu_col = "PULocationID",
                                   do_col = "DOLocationID",
                                   map_title = "FHvHV flow on July 2025",
                                   save_path = "C:/114-1_Autumn/Data_science_and_social_inquiry/nyc_mapping/post_map_fhvhv.png")

```