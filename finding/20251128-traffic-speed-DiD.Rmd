---
title: "20251128-traffic-speed-DiD"
author: "Cheng-Heng, Yuan"
output: html_document
date: "`r format(Sys.time(), '%Y-%m-%d')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Background

- **Author**: `<Cheng-Heng, Yuan>`
- **Created At**: `<2025-11-28>`
- **Research Motivation and Context (why are we interested in the findings?)：** We want to see the average speed change after the implementation of congestion fee policy.
- **Main Findings and Takeaways：** The DID analysis suggests that congestion pricing increased CBD traffic speeds by about 1.6 mph relative to non-CBD routes, with the positive effect aligning with descriptive patterns but remaining statistically imprecise given heterogeneous timing and few route-level clusters.

```{r}
# Load packages here
library(dplyr)
library(fixest)
library(tidyverse)
library(forcats)
library(lubridate)
library(tidyr)
library(purrr)
library(ggplot2)
library(slider)
```

```{r}
# Load input data here and please finish all the data manipulation here.
processed_speeds <- read.csv("speed-mht.csv")
speeds <- processed_speeds %>%
  select(ID, SPEED, TRAVEL_TIME, DATA_AS_OF, is_in_CBD) %>%
  rename(id = ID, speed = SPEED, travel_time = TRAVEL_TIME, datetime = DATA_AS_OF, CBD = is_in_CBD) %>%
  mutate(
    CBD = case_when(CBD == "not in CBD" ~ 0, CBD == "partially or all in CBD" ~ 1),
    datetime = ymd_hms(datetime),
    hour = lubridate::hour(datetime),
    month = lubridate::month(datetime),
    post = as.integer(lubridate::year(datetime) == 2025),
    is_weekend = lubridate::wday(datetime) %in% c(1, 7),
  ) %>%
  filter(speed > 0, travel_time > 0, month <= 10)

head(speeds, 10)
# Finish this block by printing the first ten observations of the data.
# Note:
# - You may only read data from /data/processed.
# - Files in /data/processed should already be cleaned and prepared for analysis.
# - Beyond simple filtering of observations or generating a small number of variables,
#   further data manipulation is not allowed. If more extensive changes are needed,
#   update the source data instead.
```


```{r}
# Before conducting the analysis, report summary statistics for all variables 
# that will be used in this notebook:
#   - For numeric variables: mean, min, 25th percentile, median, 75th percentile, 
#     max, standard deviation, and number of observations.
#   - For categorical variables: number of observations and the counts/percentages 
#     of the ten most frequent categories.
# Conclude this block with the complete summary statistics.

# number of observations
nrow(speeds)

summary_stats <- function(var) {
  s <- summary(speeds[[var]])
  sd_val <- sd(speeds[[var]], na.rm = TRUE)

  tibble(
    variable = var,
    stat = c(names(s), "sd"),
    value = c(as.character(s), sprintf("%.4f", sd_val))
  )
}

vars <- c("id", "speed", "travel_time", "datetime")
combined_summary <- map_dfr(vars, summary_stats) %>%
  pivot_wider(
    names_from = stat,
    values_from = value
  )
combined_summary

#categorical variables
summary_category <- speeds %>%
  select(CBD, post, month, hour, is_weekend) %>%
  pivot_longer(
    cols = everything(),
    names_to = "variable",
    values_to = "category"
  ) %>%
  group_by(variable, category) %>%
  summarise(
    n = n(),
    .groups = "drop_last"
  ) %>%
  mutate(ratio = n / sum(n)) %>%
  ungroup()

summary_category
```

### The actual analysis starts below
```{r}
did_fe <- feols(
  speed ~
    CBD:post +
    post +
    is_weekend +
    factor(month) +
    factor(hour) |
    id,
  data    = speeds,
  weights = ~ travel_time,
  cluster = ~ id
) 
summary(did_fe)
```
Controlling for route fixed effects and detailed time controls, the DID estimate suggests that congestion pricing increased CBD traffic speeds by approximately 1.6 mph relative to non-CBD routes. Although the estimate is not statistically significant at conventional levels, its magnitude and direction are consistent with the descriptive evidence, and the imprecision likely reflects heterogeneous effects over time and the small number of route-level clusters.
