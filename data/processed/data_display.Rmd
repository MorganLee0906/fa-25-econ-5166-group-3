---
title: "Data ready for presentation 10/14"
author: "Group 3"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: '3'
    df_print: paged
  html_notebook:
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: true
---

## Cliamte Data

In this section we display the climate data we currently have. The CO2 and AQI represents the mean value of the corresponding day, ranging from 2024/01/01 to 2025/3/29. For the data processing part and the specific location of the station, please see the data processing file for climate data.

```{r Importing data, include = FALSE}
library(sf)
library(tmap)
library(dplyr)
library(tidyr)
library(arrow)
library(ggplot2)

# Reading Data
climate = read.csv("processed_pm2.5_AQI.csv") %>% 
  select(c(-X)) %>%
  mutate(Date = as.Date(Date, format = "%m/%d/%Y"))
```

```{r}
# Summary Statistics
climate %>%
  summary()
```

# Plot for PM2.5

```{r}
ggplot(climate, aes(x = Date, y = PM2.5)) +
  geom_line(color = "darkblue", width = 1.5) +
  labs(
    title = "PM2.5 Levels at East Village, Manhattan Over Time",
    x = "Date",
    y = "PM2.5 (µg/m³)"
  ) +
  theme_minimal(base_size = 14)
```

# Plot for AQI

```{r}
ggplot(climate, aes(x = Date, y = AQI)) +
  geom_line(color = "darkgreen", width = 1.5) +
  labs(
    title = "AQI at East Village, Manhattan Over Time",
    x = "Date",
    y = "AQI"
  ) +
  theme_minimal(base_size = 14)
```

------------------------------------------------------------------------

# MTA Subway Data

We've combined MTA ridership data from July 2024 to June 2025 to the file `data.parquet`.

```{r initialize, include= FALSE}
library(data.table)
library(dplyr)
library(arrow)
library(ggplot2)
library(lubridate)
```

```{r load_MTA_data}
ds_new <- open_dataset("~/Documents/DataScience/data.parquet", format = "parquet")
ds_new <- ds_new %>%
    collect()
head(ds_new)

stationSet <- unique(ds_new[, c("Origin Station Complex Name", "Destination Station Complex Name")])

stationSet <- ds_new %>%
  group_by(`Origin Station Complex Name`, `Destination Station Complex Name`) %>%
  summarise(avg_ridership = mean(`Estimated Average Ridership`, na.rm = TRUE), .groups = "drop") %>%
  arrange(desc(avg_ridership))
```

```{r MTA_overall_trend}
overall_trend <- ds_new %>%
    select(c(Year, Month, `Estimated Average Ridership`)) %>%
    mutate(
        YearMonth = ym(sprintf("%d%02d", Year, Month))
    ) %>%
    group_by(YearMonth) %>%
    summarise(Monthly_Ridership = sum(`Estimated Average Ridership`, na.rm = TRUE))

overall_trend %>%
    ggplot(aes(x = YearMonth, y = Monthly_Ridership)) +
    geom_line(size = 1) +
    geom_point(size = 2) +
    labs(
        title = "Monthly Ridership Trend (Overall)",
        x = "Month",
        y = "Estimated Average Ridership",
    ) +
    scale_x_date(
        date_breaks = "1 month",
        date_labels = "%Y-%m"
    ) +
    theme_minimal(base_size = 14) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    )
```

```{r MTA_top5_routes}
top5_routes <- stationSet %>%
    slice_head(n = 5)

top5_data <- ds_new %>%
    inner_join(top5_routes,
        by = c("Origin Station Complex Name", "Destination Station Complex Name")
    )

top5_data <- top5_data %>%
    select(c(Year, Month, `Day of Week`, `Hour of Day`, `Origin Station Complex Name`, `Destination Station Complex Name`, `Estimated Average Ridership`)) %>%
    mutate(
        YearMonth = ym(sprintf("%d%02d", Year, Month))
    )

monthly_trend <- top5_data %>%
    group_by(YearMonth, `Origin Station Complex Name`, `Destination Station Complex Name`) %>%
    summarise(Monthly_Ridership = sum(`Estimated Average Ridership`, na.rm = TRUE))


monthly_trend %>%
    mutate(Route = paste(`Origin Station Complex Name`, "→", `Destination Station Complex Name`)) %>%
    ggplot(aes(x = YearMonth, y = Monthly_Ridership, color = Route, group = Route)) +
    geom_line(size = 1) +
    geom_point(size = 2) +
    labs(
        title = "Monthly Ridership Trend (Top Routes)",
        x = "Month",
        y = "Estimated Average Ridership",
        color = "Route"
    ) +
    scale_x_date(
        date_breaks = "1 month",
        date_labels = "%Y-%m"
    ) +
    theme_minimal(base_size = 14) +
    theme(
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.box = "horizontal",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 9),
        axis.text.x = element_text(angle = 45, hjust = 1)
    ) +
    guides(color = guide_legend(nrow = 5))
```
